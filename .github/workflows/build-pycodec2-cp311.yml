name: Build pycodec2 for Android (Python 3.11)

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      pycodec2_version:
        description: 'pycodec2 version to build'
        required: false
        default: '4.1.1'
      codec2_version:
        description: 'Codec2 C library version'
        required: false
        default: '1.2.0'

env:
  PYCODEC2_VERSION: ${{ github.event.inputs.pycodec2_version || '4.1.1' }}
  CODEC2_VERSION: ${{ github.event.inputs.codec2_version || '1.2.0' }}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - abi: arm64_v8a
            cmake_abi: arm64-v8a
            python_arch: aarch64
          - abi: x86_64
            cmake_abi: x86_64
            python_arch: x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: |
          pip install cython numpy wheel setuptools
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build patchelf

      - name: Download Codec2 source
        run: |
          curl -fsSL -H "Accept: application/vnd.github+json" \
            -o codec2.tar.gz \
            "https://api.github.com/repos/drowe67/codec2/tarball/refs/tags/${{ env.CODEC2_VERSION }}"
          tar xzf codec2.tar.gz
          mv drowe67-codec2-* codec2-src

      - name: Download pycodec2 source
        run: |
          curl -fsSL -H "Accept: application/vnd.github+json" \
            -o pycodec2.tar.gz \
            "https://api.github.com/repos/gregorias/pycodec2/tarball/refs/tags/v${{ env.PYCODEC2_VERSION }}"
          tar xzf pycodec2.tar.gz
          mv gregorias-pycodec2-* pycodec2-src

      - name: Set up Android NDK
        run: |
          echo "ANDROID_NDK=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "Using NDK at: $ANDROID_NDK_HOME"

      - name: Build Codec2 for Android
        run: |
          export CODEC2_INSTALL=$PWD/codec2-install
          mkdir -p $CODEC2_INSTALL

          cd codec2-src
          mkdir -p build && cd build

          # Use API level 24 where complex math functions are available in bionic
          cmake .. \
            -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.cmake_abi }} \
            -DANDROID_NATIVE_API_LEVEL=24 \
            -DANDROID_STL=c++_shared \
            -DBUILD_SHARED_LIBS=ON \
            -DUNITTEST=OFF \
            -DINSTALL_EXAMPLES=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$CODEC2_INSTALL

          ninja
          ninja install

          echo "CODEC2_INSTALL=$CODEC2_INSTALL" >> $GITHUB_ENV
          ls -la $CODEC2_INSTALL/lib/
          ls -la $CODEC2_INSTALL/include/codec2/

      - name: Build pycodec2 extension
        run: |
          cd pycodec2-src

          # Get the Android toolchain compiler
          if [ "${{ matrix.cmake_abi }}" == "arm64-v8a" ]; then
            COMPILER_PREFIX="aarch64-linux-android"
          else
            COMPILER_PREFIX="x86_64-linux-android"
          fi

          TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          export CC="$TOOLCHAIN/bin/${COMPILER_PREFIX}24-clang"
          export CXX="$TOOLCHAIN/bin/${COMPILER_PREFIX}24-clang++"
          export AR="$TOOLCHAIN/bin/llvm-ar"
          export STRIP="$TOOLCHAIN/bin/llvm-strip"

          # Get host Python include path (Python C API is stable across platforms)
          PYTHON_INCLUDE=$(python -c "import sysconfig; print(sysconfig.get_path('include'))")
          NUMPY_INCLUDE=$(python -c "import numpy; print(numpy.get_include())")

          # Set up include/library paths
          # -fPIC is required for shared libraries on Android
          export CFLAGS="-I$CODEC2_INSTALL/include -I$PYTHON_INCLUDE -I$NUMPY_INCLUDE -fPIC"
          export LDFLAGS="-L$CODEC2_INSTALL/lib -lcodec2 -shared"

          # Generate the Cython extension
          cd pycodec2
          cython -3 pycodec2.pyx -o pycodec2.c

          # Compile the extension
          # Note: We don't link against libpython - it's loaded dynamically at runtime by Chaquopy
          $CC $CFLAGS -c pycodec2.c -o pycodec2.o
          $CC -shared pycodec2.o -o pycodec2.cpython-311-${{ matrix.python_arch }}-linux-android.so \
            -L$CODEC2_INSTALL/lib -lcodec2

          ls -la *.so

      - name: Create wheel
        run: |
          mkdir -p dist
          mkdir -p wheel_build/pycodec2
          cd wheel_build

          # Copy the extension
          cp ../pycodec2-src/pycodec2/*.so pycodec2/

          # Copy libcodec2.so
          cp $CODEC2_INSTALL/lib/libcodec2.so pycodec2/

          # Create __init__.py that pre-loads libcodec2 using printf to avoid heredoc issues
          printf '%s\n' \
            "# Pre-load libcodec2.so before importing the extension module" \
            "import os as _os" \
            "import ctypes as _ctypes" \
            "" \
            "_this_dir = _os.path.dirname(_os.path.abspath(__file__))" \
            "_libcodec2_path = _os.path.join(_this_dir, 'libcodec2.so')" \
            "" \
            "if _os.path.exists(_libcodec2_path):" \
            "    try:" \
            "        _ctypes.CDLL(_libcodec2_path, mode=_ctypes.RTLD_GLOBAL)" \
            "    except OSError as e:" \
            "        import sys" \
            '        print(f"Warning: Could not load libcodec2.so: {e}", file=sys.stderr)' \
            "" \
            "from .pycodec2 import *" \
            > pycodec2/__init__.py

          # Create METADATA
          mkdir -p pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info
          printf "Metadata-Version: 2.1\nName: pycodec2\nVersion: ${{ env.PYCODEC2_VERSION }}\nSummary: Cython wrapper for codec2\n" \
            > pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/METADATA

          printf "Wheel-Version: 1.0\nGenerator: manual-build\nRoot-Is-Purelib: false\nTag: cp311-cp311-android_24_${{ matrix.abi }}\n" \
            > pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/WHEEL

          printf "pycodec2\n" > pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/top_level.txt

          # Create RECORD with proper sha256 hashes and sizes
          # Function to compute hash,size for a file
          record_entry() {
            local file="$1"
            local path="$2"
            local hash=$(sha256sum "$file" | cut -d' ' -f1 | xxd -r -p | base64 | tr '+/' '-_' | tr -d '=')
            local size=$(stat -c%s "$file")
            echo "$path,sha256=$hash,$size"
          }

          # Add entries for all files
          record_entry "pycodec2/__init__.py" "pycodec2/__init__.py" >> pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/RECORD
          record_entry "pycodec2/libcodec2.so" "pycodec2/libcodec2.so" >> pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/RECORD
          for f in pycodec2/*.cpython*.so; do
            [ -f "$f" ] && record_entry "$f" "pycodec2/$(basename $f)" >> pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/RECORD
          done
          record_entry "pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/METADATA" "pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/METADATA" >> pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/RECORD
          record_entry "pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/WHEEL" "pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/WHEEL" >> pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/RECORD
          record_entry "pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/top_level.txt" "pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/top_level.txt" >> pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/RECORD
          # RECORD file itself has no hash
          echo "pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/RECORD,," >> pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info/RECORD

          # Create the wheel
          WHEEL_NAME="pycodec2-${{ env.PYCODEC2_VERSION }}-cp311-cp311-android_24_${{ matrix.abi }}.whl"
          zip -r "../dist/$WHEEL_NAME" pycodec2 pycodec2-${{ env.PYCODEC2_VERSION }}.dist-info

          echo "Built wheel: $WHEEL_NAME"
          ls -la ../dist/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: pycodec2-cp311-${{ matrix.abi }}
          path: dist/*.whl
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: wheels
          merge-multiple: true

      - name: List wheels
        run: ls -la wheels/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: wheels/*.whl
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
