name: Build pycodec2 for Android

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      pycodec2_version:
        description: 'pycodec2 version to build'
        required: false
        default: '4.1.1'
      codec2_version:
        description: 'Codec2 C library version'
        required: false
        default: '1.2.0'

env:
  PYCODEC2_VERSION: ${{ github.event.inputs.pycodec2_version || '4.1.1' }}
  CODEC2_VERSION: ${{ github.event.inputs.codec2_version || '1.2.0' }}

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        abi: [arm64_v8a, x86_64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install cibuildwheel and build tools
        run: |
          pip install cibuildwheel
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Download Codec2 source
        run: |
          # Use GitHub API to download release tarball (tag is 1.2.0 not v1.2.0)
          curl -fsSL -H "Accept: application/vnd.github+json" \
            -o codec2.tar.gz \
            "https://api.github.com/repos/drowe67/codec2/tarball/refs/tags/${{ env.CODEC2_VERSION }}"
          tar xzf codec2.tar.gz
          # The extracted directory has a different name format from API
          mv drowe67-codec2-* codec2-src
          ls -la codec2-src/

      - name: Download and prepare pycodec2 source
        run: |
          # Download from GitHub to get complete source
          curl -fsSL -H "Accept: application/vnd.github+json" \
            -o pycodec2.tar.gz \
            "https://api.github.com/repos/gregorias/pycodec2/tarball/refs/tags/v${{ env.PYCODEC2_VERSION }}"
          tar xzf pycodec2.tar.gz
          mv gregorias-pycodec2-* pycodec2-src

          # Verify source structure
          ls -la pycodec2-src/
          ls -la pycodec2-src/pycodec2/ || echo "pycodec2 dir not found"

          # Create pyproject.toml for cibuildwheel
          cd pycodec2-src

          cat > pyproject.toml << 'PYPROJECT_EOF'
          [build-system]
          requires = ["setuptools>=61", "wheel", "cython>=0.29", "numpy>=1.20"]
          build-backend = "setuptools.build_meta"

          [tool.cibuildwheel]
          build = "cp313-*"
          skip = ""

          [tool.cibuildwheel.android]
          archs = ["arm64_v8a", "x86_64"]

          before-all = """
          set -ex
          # Build Codec2 for Android - install to a fixed absolute path
          export CODEC2_INSTALL=/tmp/codec2-install
          mkdir -p $CODEC2_INSTALL

          cd codec2-src
          mkdir -p build && cd build

          cmake .. \
              -G Ninja \
              -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \
              -DANDROID_ABI=$ANDROID_ABI \
              -DANDROID_NATIVE_API_LEVEL=24 \
              -DANDROID_STL=c++_shared \
              -DBUILD_SHARED_LIBS=ON \
              -DUNITTEST=OFF \
              -DINSTALL_EXAMPLES=OFF \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=$CODEC2_INSTALL

          ninja
          ninja install
          ls -la $CODEC2_INSTALL/lib/
          ls -la $CODEC2_INSTALL/include/codec2/
          """

          environment = { LIBRARY_PATH = "/tmp/codec2-install/lib", C_INCLUDE_PATH = "/tmp/codec2-install/include", CPLUS_INCLUDE_PATH = "/tmp/codec2-install/include", LDFLAGS = "-L/tmp/codec2-install/lib -lcodec2", CFLAGS = "-I/tmp/codec2-install/include" }

          repair-wheel-command = """
          set -ex
          # Bundle libcodec2.so into the wheel
          unzip -q {wheel} -d wheel_tmp

          pkg_dir=$(find wheel_tmp -name "pycodec2" -type d | head -1)
          if [ -n "$pkg_dir" ]; then
              cp /tmp/codec2-install/lib/libcodec2.so* "$pkg_dir/" || echo "Warning: libcodec2.so not found"
          fi

          cd wheel_tmp
          rm -f {wheel}
          zip -q -r {wheel} .
          cd ..
          rm -rf wheel_tmp
          """
          PYPROJECT_EOF

          # Copy codec2-src to where the build can find it
          cp -r ../codec2-src .

      - name: Build wheel with cibuildwheel
        env:
          CIBW_BUILD: "cp313-android_${{ matrix.abi }}"
        run: |
          cd pycodec2-src
          cibuildwheel --platform android --output-dir ../dist

      - name: List built wheels
        run: |
          ls -la dist/ || echo "No dist directory"

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: pycodec2-${{ matrix.abi }}
          path: dist/*.whl
          if-no-files-found: warn

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: wheels
          merge-multiple: true

      - name: List wheels
        run: ls -la wheels/ || echo "No wheels found"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: wheels/*.whl
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
